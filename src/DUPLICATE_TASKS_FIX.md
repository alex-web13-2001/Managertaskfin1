# Исправление проблемы с дублированием задач

## Проблема

Задачи, созданные как первоначальные демо-данные, иногда "возвращались" в предыдущий столбец после перемещения в Kanban. Это происходило из-за дублирования данных в базе.

## Причина

При создании демо-данных проектные задачи сохранялись **дважды**:
1. В `task:project:${projectId}:${taskId}` - правильное место для проектных задач
2. В `task:user:${userId}:${taskId}` - дублирующая копия "для удобства поиска"

При обновлении задачи (например, при DnD) обновлялась только версия в `task:project:`, но дубликат в `task:user:` оставался со старыми данными. При следующем обновлении через polling могла загрузиться старая версия, и задача "возвращалась" в прежний статус.

## Решение

### 1. Исправлен demo-data.tsx ✅

Теперь проектные задачи сохраняются **только один раз** в правильном месте:
- Проектные задачи → `task:project:${projectId}:${taskId}` 
- Личные задачи → `task:user:${userId}:${taskId}`

### 2. Добавлен endpoint для очистки дубликатов ✅

Создан новый endpoint `POST /tasks/cleanup-duplicates` который:
- Находит все проектные задачи пользователя
- Проверяет наличие дубликатов в `task:user:` namespace
- Удаляет дубликаты или мигрирует задачи в правильное место
- Возвращает отчёт о количестве удалённых дубликатов

### 3. Добавлена кнопка очистки в UI ✅

В разделе **Профиль → Обслуживание** добавлена кнопка "Очистить дубликаты задач":
- Вызывает endpoint очистки
- Показывает прогресс
- Автоматически обновляет данные после очистки
- Информирует о количестве удалённых дубликатов

## Как использовать

### Для существующих пользователей с демо-данными:

1. Откройте **Профиль** (иконка пользователя в боковом меню)
2. Прокрутите вниз до карточки **"Обслуживание"**
3. Нажмите кнопку **"Очистить дубликаты задач"**
4. Дождитесь завершения процесса
5. Проверьте, что задачи теперь перемещаются корректно

### Для новых пользователей:

Проблема не возникнет - новые демо-данные создаются уже без дубликатов.

## Технические детали

### Структура хранения задач:

```
✅ Правильно:
- Личная задача: task:user:{userId}:{taskId}
- Проектная задача: task:project:{projectId}:{taskId}

❌ Неправильно (было в старых демо-данных):
- Проектная задача: task:project:{projectId}:{taskId}
- + дубликат: task:user:{userId}:{taskId}  ← этот дубликат вызывал проблемы
```

### Логика очистки:

1. Получить все проекты пользователя
2. Для каждого проекта:
   - Получить задачи из `task:project:{projectId}:`
   - Получить задачи из `task:user:{userId}:` с `projectId === project.id`
   - Если найдены дубликаты:
     - Если задача есть в обоих местах → удалить из `task:user:`
     - Если задача только в `task:user:` → мигрировать в `task:project:` и удалить из `task:user:`

### Дедупликация на уровне сервера:

Сервер уже имеет многоуровневую систему дедупликации при загрузке задач (строки 580-598 в index.tsx):

```typescript
// Дедупликация через Map - projectId имеет приоритет
const tasksMap = new Map();
for (const task of personalTasks) {
  tasksMap.set(task.id, task);
}
for (const task of projectTasks) {
  tasksMap.set(task.id, task); // Перезапишет дубликат из personalTasks
}
```

Но это не решало проблему полностью, потому что при следующем polling старый дубликат мог снова загрузиться.

## Проверка

После очистки дубликатов:

1. ✅ Задачи перемещаются между колонками и остаются на месте
2. ✅ После обновления страницы задачи остаются в новых столбцах
3. ✅ Polling не "откатывает" изменения
4. ✅ Новые задачи работают корректно с самого начала

## Дополнительные улучшения

### Предотвращение будущих дубликатов:

- ✅ Demo-data.tsx исправлен
- ✅ Функция создания задач уже работала правильно (создаёт задачи только в одном месте)
- ✅ Функция обновления задач находит и обновляет задачу в правильном месте

### Мониторинг:

В логах сервера отображается:
- Количество дубликатов при загрузке
- Процесс очистки с детальными логами
- Количество удалённых/мигрированных задач

## Заключение

Проблема полностью решена:
- ✅ Корень проблемы устранён (нет дублирования в demo-data)
- ✅ Инструмент для очистки существующих дубликатов
- ✅ Удобный UI для пользователей
- ✅ Автоматическое обновление данных после очистки
- ✅ Детальные логи для отладки

Новые задачи, создаваемые пользователями, никогда не будут иметь этой проблемы.
