# üéØ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã CONNECTION_REFUSED - 10 –Ω–æ—è–±—Ä—è 2025

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

### –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã
Frontend –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∞–ª –∂–µ—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω—ã–π URL `http://localhost:3001`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –∫–∞–∫ fallback –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `VITE_API_BASE_URL` –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—Ä–∞—É–∑–µ—Ä –ø—ã—Ç–∞–ª—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ `http://localhost:3001/api/auth/signin` –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Nginx proxy –Ω–∞ `https://kanban.24task.ru/api/auth/signin`

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

–ò–∑–º–µ–Ω–µ–Ω fallback URL —Å `'http://localhost:3001'` –Ω–∞ `''` (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞) –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:

| –§–∞–π–ª | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
|------|---------------------|
| `src/utils/api-client.tsx` | 1 |
| `src/contexts/app-context.tsx` | 4 |
| `src/components/invite-accept-page.tsx` | 1 |
| **–í—Å–µ–≥–æ** | **6 –∏–∑–º–µ–Ω–µ–Ω–∏–π** |

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

#### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```javascript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001';
// –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ production: http://localhost:3001/api/auth/signin ‚ùå
```

#### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```javascript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '';
// –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ production: /api/auth/signin ‚úÖ
// –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω: https://kanban.24task.ru/api/auth/signin
```

### –ü–æ—Ç–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ —Ç–µ–ø–µ—Ä—å:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   ‚Üì
2. Frontend –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å: POST /api/auth/signin
   ‚Üì
3. –ë—Ä–∞—É–∑–µ—Ä –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤: POST https://kanban.24task.ru/api/auth/signin
   ‚Üì
4. Nginx –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/auth/signin
   ‚Üì
5. Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞: POST http://127.0.0.1:3001/api/auth/signin
   ‚Üì
6. Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω
   ‚Üì
7. Frontend –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç ‚úÖ
```

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
# 1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/Managertaskfin1

# 2. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin copilot/fix-nginx-proxy-issues-again

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
npm install

# 4. –°–æ–±–µ—Ä–∏—Ç–µ frontend
npm run build

# 5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–±–æ—Ä–∫—É –≤ nginx –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
sudo rm -rf /var/www/kanban.24task.ru.old
sudo mv /var/www/kanban.24task.ru /var/www/kanban.24task.ru.old
sudo cp -r build /var/www/kanban.24task.ru
sudo chown -R www-data:www-data /var/www/kanban.24task.ru

# 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ nginx
sudo systemctl reload nginx
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä** (–ª—É—á—à–µ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ)
2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞** https://kanban.24task.ru
3. **–û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à** (Ctrl+Shift+R –∏–ª–∏ Cmd+Shift+R)
4. **–û—Ç–∫—Ä–æ–π—Ç–µ DevTools** (F12) ‚Üí Network tab
5. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏** —Å –ª–æ–≥–∏–Ω–æ–º `admin@kanban.24task.ru` –∏ –ø–∞—Ä–æ–ª–µ–º
6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab:**
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ `/api/auth/signin`
   - Request URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://kanban.24task.ru/api/auth/signin`
   - Status Code –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `200 OK`
   - Response –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å JWT —Ç–æ–∫–µ–Ω

### ‚úÖ –ü—Ä–∏–∑–Ω–∞–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ CONNECTION_REFUSED –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞ `https://kanban.24task.ru/api/*` –∞ –Ω–µ –Ω–∞ `localhost:3001`
- ‚úÖ Login —Ä–∞–±–æ—Ç–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—Å–µ API –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Nginx

### ‚ùå –ü—Ä–∏–∑–Ω–∞–∫–∏ —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞:

- ‚ùå –í Network tab –≤–∏–¥–Ω–æ –∑–∞–ø—Ä–æ—Å—ã –∫ `http://localhost:3001`
- ‚ùå –û—à–∏–±–∫–∞ `net::ERR_CONNECTION_REFUSED`
- ‚ùå Login –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –ö–æ–Ω—Å–æ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç CORS –æ—à–∏–±–∫–∏

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω —Ñ–∞–π–ª —Å–±–æ—Ä–∫–∏:
- **–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è:** `index-C3D9XXV3.js` (898.57 KB)
- **–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:** `index-D7m5LzlL.js` (898.44 KB)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

#### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ):
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:
```bash
VITE_API_BASE_URL="http://localhost:3001"
```

#### –î–ª—è production (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ):
**–ù–ï —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ** `.env` —Ñ–∞–π–ª –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º:
```bash
# VITE_API_BASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ - –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—É—Å—Ç–æ–π fallback
```

### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
```nginx
location /api {
    proxy_pass http://127.0.0.1:3001/api;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

### Backend —Ä–æ—É—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
- `/auth/signin` - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- `/auth/me` - —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `/health` - health check
- –ò —Ç.–¥. (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `/api`)

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã:
- ‚úÖ –°–±–æ—Ä–∫–∞ frontend —É—Å–ø–µ—à–Ω–∞ (`npm run build`)
- ‚úÖ –ù–µ—Ç TypeScript –æ—à–∏–±–æ–∫
- ‚úÖ CodeQL security scan - 0 —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑–º–µ–Ω–µ–Ω—ã
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (6 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)

### üß™ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
1. ‚úÖ curl –∫ backend –Ω–∞–ø—Ä—è–º—É—é —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ curl —á–µ—Ä–µ–∑ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚è≥ Login —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è)

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ **DEPLOYMENT_INSTRUCTIONS.md**

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend:**
   ```bash
   pm2 logs kanban-taskmanager-api --lines 50
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx:**
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ backend —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 3001:**
   ```bash
   ss -tlnp | grep 3001
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ PM2 —Å—Ç–∞—Ç—É—Å:**
   ```bash
   pm2 status
   pm2 describe kanban-taskmanager-api
   ```

5. **–¢–µ—Å—Ç–æ–≤—ã–π curl –∑–∞–ø—Ä–æ—Å:**
   ```bash
   curl -X POST https://kanban.24task.ru/api/auth/signin \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@kanban.24task.ru","password":"Admin123!"}' \
     -v
   ```

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ hardcoded URL `localhost:3001` –≤ frontend –∫–æ–¥–µ. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–Ω—è–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ 6 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, –∑–∞–º–µ–Ω–∏–≤ fallback –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ Nginx proxy.

**–†–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!** üöÄ
